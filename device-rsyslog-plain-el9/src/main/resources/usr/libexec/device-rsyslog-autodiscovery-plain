#!/bin/bash
  
#
# RSyslog Autodiscovery - Listen
# ==============================
#
# This script tells rsyslog to listen on open port 514.

set -e

exec 2> >(logger -t ${0})

#
# Add/remove listen

line=/etc/device/services/syslog/plain/

bind="port=\"514\""

if test -f "$line/protocol.txt"; then
  protocol="$(head -n 1 $line/protocol.txt)"
  if test "${protocol}" == "ipv4-only"; then
    bind="address=\"0.0.0.0\" port=\"514\""
  elif test "${protocol}" == "ipv6-only"; then
    bind="address=\"::\" port=\"514\""
  fi
fi

if test -L "$line/zone.xml"; then

  cat >> plain.conf <<- EOF
# Generated by $0 on `date`
# DO NOT MODIFY THIS FILE - it will be overwritten on server restart.
#

# Provides UDP syslog reception
# for parameters see http://www.rsyslog.com/doc/imudp.html
module(load="imudp") # needs to be done just once
input(type="imudp" ${bind})

# Provides TCP syslog reception
# for parameters see http://www.rsyslog.com/doc/imtcp.html
module(load="imtcp") # needs to be done just once
input(type="imtcp" ${bind})

EOF

  install -o root -g root -m 644 plain.conf /etc/rsyslog.d/10-plain.conf

else

  rm -f /etc/rsyslog.d/10-plain.conf

fi


